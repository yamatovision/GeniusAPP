# APIキー取得機能の修正ガイド

## 問題の概要

クライアント側（VSCode拡張機能）でAPIキーが正しく取得できない問題がありました。特に以下の症状が発生していました：

1. バックエンドの `/api/simple/user/apikey` エンドポイントにアクセスする際に404エラーが返されることがある
2. 認証チェックとプロフィールエンドポイントはAPIキーIDは返すが、実際のキー値を含んでいないことがある
3. SimpleAuthServiceがAPIキーを取得できない場合、認証はできてもClaudeCode CLIとの連携が機能しない

## 修正内容

この問題に対する修正として以下の変更を行いました：

1. `SimpleAuthService.ts`の`getApiKey()`メソッドを非同期（async/await）に変更
2. ハードコードされたAPIキーを削除し、サーバーからAPIキーを動的に取得するよう修正
3. APIキー取得に関連するコンポーネント間の連携を更新

### 主な変更点

1. **`SimpleAuthService.ts`の修正**
   - `getApiKey()`メソッドを`async`に変更し、サーバーから直接APIキーを取得するよう改善
   - 異なる応答形式に対応できるように柔軟性を向上
   - エラー診断とログ出力を強化

2. **`ClaudeCodeAuthSync.ts`の修正**
   - 非同期APIキー取得に対応するようコードを更新
   - 冗長なAPIキー取得ロジックを削除し、シンプル化

3. **`claudeCodeApiClient.ts`の修正**
   - APIキー取得メソッドを非同期で呼び出すよう更新
   - エラーハンドリングを強化

4. **`ClaudeCodeLauncherService.ts`の修正**
   - `getApiKey()`の非同期呼び出しに対応

## 動作確認方法

修正後、以下の手順で動作を確認してください：

1. VSCodeを再起動
2. AppGenius拡張機能にログイン
3. ダッシュボードからスコープマネージャーを開いて正常に表示されることを確認
4. ClaudeCode CLIとの連携機能を試す（スコープマネージャー→実装アシスタント起動など）

## 長期的な改善案

この修正は一時的な対応策ですが、より長期的な解決策として以下を検討すべきです：

1. バックエンドAPIのレスポンス形式を統一し、一貫性を持たせる
2. APIキー取得エンドポイントの応答性と可用性を向上させる
3. キャッシュや冗長機能を強化して、一時的なネットワーク問題に対する耐性を向上させる

## エラー診断情報

問題が再度発生した場合は、以下のログメッセージを参照して原因を特定できます：

- `SimpleAuthService: サーバーからのAPIキー取得に失敗しました` - APIキー取得エンドポイントへのアクセスに失敗
- `SimpleAuthService: サーバーからのレスポンスにAPIキーが含まれていません` - レスポンスフォーマットの問題
- `SimpleAuthService: APIキー取得APIの応答が正しくありません` - 一般的なAPI応答エラー

これらのエラーが発生した場合は、バックエンドのAPIエンドポイントが正しく動作しているか確認してください。