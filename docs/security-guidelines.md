# AppGenius セキュリティガイドライン

## 概要

このドキュメントは、AppGeniusアプリケーションの開発および運用にあたってのセキュリティガイドラインを提供します。AppGeniusは、VSCode拡張機能として動作し、中央ポータルとの連携を行うアプリケーションです。本ドキュメントでは、認証、データ保護、API通信などの観点からセキュリティベストプラクティスを説明します。

## 認証セキュリティ

### トークン管理

AppGeniusは、JWTトークンベースの認証システムを採用しています。トークン管理においては以下のベストプラクティスを遵守してください：

1. **トークンの安全な保存**
   - トークンは必ずVSCode Secret Storage APIを使用して保存する
   - プレーンテキストでの保存は絶対に行わない
   - TokenManagerクラスを通してのみトークンにアクセスする

2. **トークンのリフレッシュメカニズム**
   - アクセストークンとリフレッシュトークンの2種類を使用する
   - アクセストークンの有効期限は短く設定（例：15分〜1時間）
   - リフレッシュトークンの有効期限は適切に設定（例：24時間〜7日）
   - 401エラー発生時は自動的にトークンリフレッシュを試みる

3. **セッション管理**
   - 定期的なトークン検証を実装する
   - セッションタイムアウト時はユーザーに通知する
   - リトライメカニズムは指数バックオフアルゴリズムを使用する

### ログアウト処理

1. **クライアント側の処理**
   - トークンを完全に削除する
   - ユーザー情報をクリアする
   - 認証状態をリセットする

2. **サーバー側の処理**
   - リフレッシュトークンを無効化する
   - アクティブセッションを終了する

## API通信セキュリティ

### HTTPS通信

1. **常にHTTPSを使用**
   - すべての本番環境のAPI通信にはHTTPSを使用する
   - 開発環境でもHTTPSの使用を推奨（localhost除く）
   - 自己署名証明書は開発時のみ許容

2. **認証ヘッダーの使用**
   - Bearer認証トークンを使用する
   - 認証ヘッダーは統一された方法で生成する
   - HTTPSなしでは認証ヘッダーを送信しない

### レート制限対策

1. **エラー処理**
   - 429（Too Many Requests）エラーを適切に処理する
   - レート制限エラー発生時はユーザーに通知する

2. **リトライロジック**
   - 指数バックオフアルゴリズムを実装する
   - 最大リトライ回数を設定する
   - リトライ間隔を適切に設定する

### エラー処理

1. **集中型エラーハンドリング**
   - ErrorHandlerクラスを使用して一元管理する
   - エラータイプに応じた適切な処理を行う
   - エラーを標準化して処理する

2. **エラーログ**
   - エラー情報を適切にログに記録する
   - 機密情報はログに記録しない
   - 重要なエラーは通知する

## フロントエンドセキュリティ

### XSS対策

1. **WebView設定**
   - Content Security Policyを設定する
   - enableScriptsは必要な場合のみtrueにする
   - localResourceRootsを制限する

2. **入力検証**
   - ユーザー入力は常にエスケープして表示する
   - HTMLインジェクションを防止する

### セキュアなデータ保存

1. **機密データの取り扱い**
   - ローカルストレージやセッションストレージには機密データを保存しない
   - 必要な場合は暗号化して保存する
   - VSCode Secret Storage APIを使用する

## セキュリティ監査

AppGeniusには、セキュリティ監査機能が組み込まれています。この機能を使用して、アプリケーションのセキュリティ状態を定期的に確認してください。

1. **定期的な監査**
   - `SecurityAuditor.getInstance().auditAll()` を定期的に実行する
   - 自動監査スケジュールを設定する
   - 監査結果を確認して対応する

2. **重大な問題への対応**
   - 重大度「HIGH」または「CRITICAL」の問題は優先的に対応する
   - セキュリティ問題の修正はテスト計画を立てて実施する
   - 修正後に再度監査を実施する

## セキュリティインシデント対応

セキュリティインシデントが発生した場合は、以下の手順に従って対応してください：

1. **発見段階**
   - インシデントの範囲と影響を評価する
   - 対応チームに報告する

2. **封じ込め段階**
   - 影響を受けるシステムを特定する
   - 必要に応じてシステムを隔離する

3. **解決段階**
   - 脆弱性を修正する
   - 影響を受けたユーザーに通知する

4. **復旧段階**
   - システムの正常動作を確認する
   - セキュリティ強化策を実施する

5. **振り返り**
   - インシデントの原因を分析する
   - 再発防止策を検討する

## セキュリティチェックリスト

### 開発時
- [ ] VSCode Secret Storage APIを使用してトークンを保存している
- [ ] アクセストークンとリフレッシュトークンの両方を使用している
- [ ] 401エラー時に自動的にトークンリフレッシュを試みる処理を実装している
- [ ] ログアウト時にクライアント側とサーバー側の両方でトークンを適切に処理している
- [ ] すべてのAPI通信でHTTPSを使用している（開発環境のlocalhost除く）
- [ ] Bearer認証トークンを使用している
- [ ] レート制限エラー（429）の処理を実装している
- [ ] リトライロジックを実装している
- [ ] 集中型エラーハンドリングを使用している
- [ ] WebViewでContent Security Policyを設定している
- [ ] ユーザー入力を適切にエスケープしている
- [ ] ローカルストレージに機密データを保存していない

### デプロイ前
- [ ] セキュリティ監査を実施している
- [ ] 監査で検出された重大な問題を修正している
- [ ] セキュリティテストを実施している
- [ ] 環境変数を適切に設定している
- [ ] 本番環境ではHTTPSを強制している

## 結論

セキュリティは継続的なプロセスです。このガイドラインに従いながら、常に最新のセキュリティベストプラクティスを学び、アプリケーションのセキュリティを向上させ続けてください。セキュリティ問題や改善提案は、開発チームに報告してください。

---

最終更新日: 2025年3月15日  
作成者: AppGenius開発チーム