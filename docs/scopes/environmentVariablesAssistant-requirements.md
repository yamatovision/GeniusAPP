# 環境変数アシスタント 要件定義

## 1. 機能概要

### 目的と主な機能
環境変数アシスタントは、非技術者でも安全かつ容易に環境変数を設定・管理できるUIを提供します。主な機能は以下の通りです：

- 必須および任意の環境変数をカード形式で一覧表示
- 環境変数ごとの詳細な設定ガイドと説明の提供
- セキュアな値の自動生成機能
- 接続テスト機能
- 進捗状況の視覚的表示
- 設定済み環境変数の.envファイルへの保存

### 想定ユーザー
- プログラミング経験の少ないビジネスユーザー
- API連携やデータベース接続設定に不慣れなユーザー
- VSCode拡張機能を使ってアプリケーション開発を行う個人開発者

## 2. UI要素の詳細

### 環境変数カード
- **表示要素**:
  - 環境変数名（例：MONGODB_URI, JWT_SECRET）
  - ステータスバッジ（必須/任意）
  - 設定状態（設定済み/未設定）のアイコンと表示
  - 説明文（環境変数の用途や重要性）
  - 入力フィールド（適切なプレースホルダー付き）
  - アクションボタン
- **カードの状態**:
  - 設定済み：緑色の左ボーダー、チェックアイコン付き
  - 必須/未設定：赤色の左ボーダー
  - 任意/未設定：黄色の左ボーダー
- **アクションボタン**:
  - 「保存」ボタン：入力内容を保存
  - 変数タイプに応じた補助ボタン（「安全な値を生成」「接続テスト」「取得方法を表示」など）
  - 「編集」ボタン（設定済み変数の場合）
  - 「このプロジェクトでは使用しない」ボタン（任意変数の場合）

### ガイドパネル
- **表示要素**:
  - 現在フォーカスされている環境変数名をタイトルとして表示
  - ステップバイステップの設定手順（番号付きリスト）
  - AIによる提案・アドバイス
  - アクションボタン
- **機能**:
  - 常に現在選択中または編集中の環境変数に関する情報を表示
  - スクロールしても上部に固定表示（sticky position）
  - リアルタイムでフィードバックを提供

### ヘッダー
- **表示要素**:
  - タイトル「環境変数アシスタント」
  - 進捗インジケーター（設定済み/全体の比率）
  - プログレスバー（視覚的な進捗表示）

### フッター
- **アクション**:
  - 「すべての環境変数を.envファイルに保存」ボタン

### 入力フィールドと検証ルール
- **MongoDB URI**:
  - フォーマット検証：有効なMongoDBの接続文字列であることを確認
  - 接続テスト機能：実際に接続できるかを検証
  
- **JWT_SECRET**:
  - 最小長：32文字以上
  - 複雑性：英数字と特殊文字を含む
  - 自動生成オプション：ボタンクリックで安全な値を生成
  
- **API_KEY**:
  - フォーマット検証：API_プレフィックスと適切な長さ
  - マスキング表示：保存後に値の一部をマスク表示
  
- **SMTP_SERVER**:
  - フォーマット検証：有効なSMTPサーバーアドレス
  - 任意フィールドのスキップオプション

## 3. データ構造

### 環境変数データモデル
```typescript
interface EnvironmentVariable {
  name: string;            // 環境変数名
  value: string;           // 設定値
  description: string;     // 説明文
  category: string;        // カテゴリ（DB, API, Auth, Mail等）
  isRequired: boolean;     // 必須かどうか
  isConfigured: boolean;   // 設定済みかどうか
  isTested?: boolean;      // テスト済みかどうか
  format?: string;         // 期待されるフォーマット（正規表現）
  guideSteps?: string[];   // ガイドステップの配列
  suggestion?: string;     // AIからの提案
}
```

### 環境変数グループ
```typescript
interface EnvironmentVariableGroup {
  id: string;              // グループID
  name: string;            // グループ名（MongoDB, JWT, API等）
  variables: EnvironmentVariable[]; // グループ内の環境変数
  dependsOn?: string[];    // 依存する他のグループID
}
```

### 永続化要件
- 設定済み環境変数は`.env`ファイルに保存
- 環境変数の説明や設定状態は`project-settings.json`に保存
- セキュリティのため、実際の値はローカルストレージのみに保存し、リモートには共有しない
- `.env.example`ファイルを自動生成（実際の値は含まず、フォーマットのみ）

## 4. API・バックエンド連携

### 必要なAPIエンドポイント

#### 環境変数管理API
- **getEnvironmentVariables**:
  - 目的：プロジェクトに必要な環境変数リストの取得
  - パラメータ：プロジェクトID
  - レスポンス：環境変数オブジェクトの配列（値を除く）

- **saveEnvironmentVariables**:
  - 目的：設定済み環境変数を.envファイルに保存
  - パラメータ：環境変数オブジェクトの配列
  - レスポンス：成功/失敗ステータス

#### 接続テストAPI
- **testDatabaseConnection**:
  - 目的：データベース接続文字列の検証
  - パラメータ：接続文字列
  - レスポンス：接続成功/失敗、エラーメッセージ

- **testAPIConnection**:
  - 目的：APIキーの検証
  - パラメータ：APIキー、エンドポイントURL
  - レスポンス：接続成功/失敗、エラーメッセージ

#### 値生成API
- **generateSecureValue**:
  - 目的：セキュアなランダム値の生成
  - パラメータ：長さ、複雑性レベル
  - レスポンス：生成された値

### ファイルシステム連携
- **読み取り操作**:
  - 既存の.envファイルの解析
  - project-settings.jsonの読み込み
  
- **書き込み操作**:
  - .envファイルの作成/更新
  - .env.exampleファイルの作成/更新
  - project-settings.jsonの更新

## 5. エラー処理

### 想定されるエラーケース
1. **接続エラー**:
   - データベース接続失敗
   - APIキー認証失敗
   - SMTPサーバー接続失敗
   
2. **入力検証エラー**:
   - 不正なフォーマットの入力
   - 必須フィールドの未入力
   - 安全でない値（短すぎるパスワードなど）
   
3. **ファイル操作エラー**:
   - .envファイル書き込み権限なし
   - 既存ファイルのバックアップ失敗
   
4. **システムエラー**:
   - AIサービス連携失敗
   - VSCode拡張API呼び出しエラー

### エラーメッセージと回復方法
1. **接続エラー対応**:
   - 具体的なエラー原因を表示（「MongoDBサーバーに接続できません。ネットワーク設定を確認してください」）
   - 考えられる解決策の提案（「IPアドレス制限が設定されていないか確認してください」）
   - 詳細なログへのアクセス方法
   
2. **入力検証エラー対応**:
   - インラインでのエラー表示（入力フィールド下に赤字でメッセージ）
   - フォーマット例の表示
   - 「安全な値を生成」などの代替オプションの提案
   
3. **ファイル操作エラー対応**:
   - 権限の問題の場合は手動での対応方法を案内
   - 一時ファイルへの出力オプションの提供
   
4. **システムエラー対応**:
   - エラーログの自動収集
   - トラブルシューティング情報の表示
   - 手動での回避方法の案内

## 6. パフォーマンス要件

### 応答時間の目標
- UI操作の応答時間：200ms以内
- 環境変数保存処理：500ms以内
- 接続テスト：3秒以内（タイムアウト設定あり）
- 値の自動生成：1秒以内

### 最適化と負荷対策
- 環境変数リストの遅延読み込み（必要な部分のみ初期表示）
- 接続テストの非同期処理（UI操作をブロックしない）
- カード表示の仮想化（多数の環境変数がある場合）
- キャッシュ機能（設定値の一時保存）

## 7. セキュリティ要件

### 認証・認可
- VSCode拡張の権限モデルに準拠
- ファイルシステム操作は最小権限の原則に従う
- 外部APIとの通信は適切な認証を行う

### データ保護
- 環境変数の値は平文でUIに表示しない（マスキング処理）
- JWT_SECRET等の機密値はクリップボードに自動コピーしない設計
- .envファイルが.gitignoreに含まれていることを確認
- .env.exampleには実際の値を含めない
- セキュリティに関するベストプラクティスをガイドに含める
- 開発環境と本番環境で異なる値を使用するよう促す

### セキュリティガイド
- 各環境変数タイプに応じたセキュリティアドバイスを表示
- APIキーのローテーション推奨
- 強力なシークレット生成のガイドライン
- 環境変数漏洩時のリスクと対応策の説明