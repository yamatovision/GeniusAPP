# バージョン履歴機能修正スコープ

## 概要
プロンプトのバージョン履歴が表示されない問題を修正します。現在バックエンドではバージョン履歴の保存機能は実装されていますが、フロントエンドでプロンプト詳細画面に「バージョン履歴はありません」と表示されている状態です。

## 成功基準
- プロンプト詳細画面でバージョン履歴タブが正常に表示される
- バージョン履歴の一覧がタイムライン形式で表示される
- 過去バージョンを選択して表示することができる
- バージョン間の差分を確認できる機能が実装される

## 対象ファイル

### バックエンド
- `portal/backend/models/promptVersion.model.js`
  - バージョン保存モデルの確認
  - 必要に応じてインデックスの最適化
- `portal/backend/controllers/prompt.controller.js`
  - バージョン取得APIエンドポイントが正しく定義されているか確認
  - バージョン一覧の取得ロジックを検証
- `portal/backend/routes/prompt.routes.js`
  - プロンプトバージョン関連のルーティングが正しく設定されているか確認

### フロントエンド
- `portal/frontend/src/components/prompts/PromptDetail.js`
  - バージョン履歴表示タブの実装修正
  - バージョン一覧が何も表示されない問題を修正
  - バージョン間の差分表示機能の追加
- `portal/frontend/src/services/prompt.service.js`
  - バージョン取得API呼び出しの修正
  - エラーハンドリングの改善

### API連携
- `portal/frontend/src/utils/api-retry.js`
  - エラー時のリトライロジックがバージョン取得にも適用されるか確認
- `src/api/claudeCodeApiClient.ts`
  - VSCode拡張でのバージョン取得機能の確認と必要な修正

## 実装計画

### ステップ1: 問題の詳細分析（2日）
1. バックエンドのプロンプトバージョンモデルとデータの検証
2. バージョン取得APIエンドポイントの動作テスト
3. フロントエンドでバージョン履歴が取得できていない原因の特定
4. クライアントとサーバー間のデータ形式の不一致の特定

### ステップ2: バックエンド修正（1-2日）
1. 必要に応じてプロンプトバージョンモデルの調整
2. バージョン取得APIエンドポイントの修正
3. バージョン一覧の取得ロジックの最適化

### ステップ3: フロントエンド修正（2-3日）
1. PromptDetail.jsのバージョン履歴取得ロジックの修正
2. バージョン履歴タブUIの改善
3. バージョン間の差分表示機能の実装
4. プロンプトサービスのバージョン取得メソッドの修正

### ステップ4: テストと統合（1日）
1. 修正したバージョン履歴機能の統合テスト
2. エラーケースのハンドリング確認
3. バージョン間の切り替え機能のテスト

## 技術的アプローチ
1. バックエンドの検証には実際のデータベースクエリログを確認し、正しいデータが返されているか検証します
2. フロントエンドでのデータフェッチとレンダリングでエラーが起きていないか確認するため、Reactデバッグツールを使用します
3. バージョン間の差分表示のために差分比較ライブラリ（例: diff）を使用します
4. WebSocketを通じたリアルタイム更新のサポートも検討します

## リスクと対策
- **リスク**: データベースにバージョン履歴が保存されていない可能性
  - **対策**: バージョン作成ロジックを検証し、必要に応じて修正する
- **リスク**: APIエンドポイントのルーティングまたはレスポンス形式に問題がある可能性
  - **対策**: 開発環境でAPIレスポンスを詳細にロギングして分析する
- **リスク**: フロントエンドがAPIレスポンスを正しく処理できていない可能性
  - **対策**: データ処理ロジックを段階的に検証し、各ステップの出力を確認する

## 依存関係
- バックエンドのMongoDBデータベース接続が正常に機能していること
- フロントエンドのReact環境が正常に構築されていること
- API認証が正しく機能していること