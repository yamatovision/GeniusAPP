# 認証メカニズム改善スコープ

## 概要
現在のJWT認証システムでは、ユーザーが頻繁にログアウトされる問題があります。リフレッシュトークンが正しく機能していない可能性があり、認証メカニズム全体の改善が必要です。短期的な修正と長期的なサードパーティ認証への移行を検討します。

## 成功基準
- ユーザーがVSCodeを再起動してもログイン状態が維持される
- アクセストークンの有効期限が切れても自動的にリフレッシュされる
- 認証が必要なAPI呼び出しが認証エラーで失敗しなくなる
- セキュリティを維持しながらユーザー体験が向上する

## 対象ファイル

### VSCode拡張側
- `src/core/auth/TokenManager.ts`
  - トークン管理ロジックの確認と改善
  - トークン有効期限のベストプラクティス適用
- `src/core/auth/AuthenticationService.ts`
  - 認証サービスの動作検証
  - トークンリフレッシュ処理の改善
- `src/utils/AuthStorageManager.ts`
  - トークン保存方法の確認と改善
  - VSCode永続化ストレージの活用

### バックエンド側
- `portal/backend/config/auth.config.js`
  - JWT設定の確認
  - トークン有効期限の長期化
- `portal/backend/controllers/auth.controller.js`
  - リフレッシュトークンエンドポイントの修正
  - エラーハンドリングの強化
- `portal/backend/services/auth.service.js`
  - トークン生成ロジックの改善
  - リフレッシュトークン処理の強化
- `portal/backend/middlewares/auth.middleware.js`
  - 認証ミドルウェアの検証と改善

### フロントエンド側
- `portal/frontend/src/utils/token-refresh.js`
  - リフレッシュトークン処理の改善
  - リトライロジックの最適化
- `portal/frontend/src/services/auth.service.js`
  - 認証サービスの改善
  - エラーハンドリングの強化

## 実装計画

### ステップ1: 現状分析と問題特定（2日）
1. 現在の認証フローを文書化
2. トークン管理の問題点を特定
3. リフレッシュトークンが機能しない原因を調査
4. ローカルストレージとVSCode永続化ストレージの使い方を検証

### ステップ2: JWT認証の短期的改善（3日）
1. トークン有効期限の最適化（アクセストークン: 24時間、リフレッシュトークン: 30日）
2. VSCode拡張でのトークン保存方法の改善
3. トークンリフレッシュロジックの修正
4. エラーハンドリングとリトライロジックの強化

### ステップ3: サードパーティ認証の調査（2日）
1. SupabaseとFirebaseの認証サービスを比較検討
2. 既存システムとの統合ポイントを特定
3. 移行計画を策定（必要に応じて）
4. コスト・ベネフィット分析の実施

### ステップ4: 統合テストとデプロイ（2日）
1. 修正した認証システムのテスト計画作成
2. 修正の適用とテスト
3. 段階的デプロイ計画の作成
4. 本番環境へのリリース

## 技術的アプローチ
1. JWTトークンの有効期限を延長し、リフレッシュトークンの有効期限はさらに長くする
2. VSCode拡張ではSecureStorageを活用して認証情報を安全に保存
3. トークンリフレッシュの自動化と失敗時のフォールバック戦略の実装
4. APIリクエスト失敗時の自動リトライとリフレッシュトークンの再利用

## リスクと対策
- **リスク**: トークン有効期限の延長によるセキュリティリスク
  - **対策**: リフレッシュトークンのローテーションと必要に応じた無効化機能の実装
- **リスク**: VSCode拡張とバックエンド間の認証同期の問題
  - **対策**: 一貫した認証状態管理と冗長な認証チェックの実装
- **リスク**: サードパーティ認証への移行コストが高い可能性
  - **対策**: 段階的な移行計画と既存システムとの並行運用期間の設定

## サードパーティ認証検討
### Supabaseの場合
- **利点**:
  - OAuth連携が容易
  - JWT認証との互換性が高い
  - データベース統合が容易
- **欠点**:
  - 追加の依存関係
  - 既存の認証データの移行が必要

### Firebaseの場合
- **利点**:
  - 広範なOAuthプロバイダーサポート
  - スケーラビリティが高い
  - セキュリティルールが強力
- **欠点**:
  - Googleへの依存
  - 既存バックエンドとの統合が複雑になる可能性

## 依存関係
- バックエンドのExpressサーバー
- フロントエンドのReactアプリケーション
- VSCode拡張のセキュアストレージAPI
- JWT認証ライブラリ