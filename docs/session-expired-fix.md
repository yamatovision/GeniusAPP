# ログイン直後のセッション有効期限切れ問題の修正

## 問題概要

ユーザーがログインした直後に「セッションの有効期限が切れました。再度ログインしてください。」というエラーメッセージが表示される問題が発生していました。

## 原因分析

調査の結果、以下の複合的な原因が特定されました：

1. **認証チェックの頻度**：認証チェックの最小間隔が長すぎて、ログイン直後の状態確認に古いキャッシュが使用される
2. **トークン検証の厳格さ**：サーバー側のトークン検証が厳格すぎて、わずかな時刻のずれでもトークンが無効と判断される
3. **エラーリカバリーの不足**：認証エラー発生時に適切なリトライ処理が実装されていない
4. **ストレージ管理の問題**：ログイン処理と認証状態確認で使用するストレージキーの一貫性不足

## 修正内容

### 1. simpleAuth.service.js の改善

1. **認証チェックの最小間隔を短縮**：
   - `MIN_AUTH_CHECK_INTERVAL`を60秒から5秒に短縮して、ログイン直後の状態確認を確実に
   - キャッシュの過度な使用を防止

2. **ログイン処理の安定化**：
   - ログイン前にローカルストレージをクリア
   - 認証情報を複数の場所にバックアップして冗長性を確保
   - キャッシュ情報もクリアして新しいセッションを確実に開始

3. **`getCurrentUser`関数の改善**：
   - エラーハンドリングの強化
   - トークンリフレッシュの自動実行
   - 認証エラー時の詳細なログ記録
   - ネットワークエラー時にはキャッシュを使用

### 2. バックエンド設定の調整

**トークン検証の余裕度を拡大**：
   - `simple-auth.config.js`の`jwtClockTolerance`を30秒から60秒に拡大
   - クライアントとサーバーの時計ずれに対する許容度を高める

### 3. Dashboard.js の強化

**ユーザー情報取得のリトライ機能実装**：
   - 最大2回のリトライを実装
   - 複数のストレージソースからユーザー情報を確認
   - サーバーからの情報取得に失敗した場合の段階的処理
   - 詳細なログ記録によるトラブルシューティングの改善

## 効果

これらの修正により：

1. ログイン直後のセッション切れエラーが解消され、ユーザー体験が向上
2. 認証処理の安定性と信頼性が向上
3. エラー発生時のリカバリー機能が強化
4. 認証情報の冗長性確保による堅牢性の向上

## 影響範囲

修正は以下のファイルに影響します：

- `/portal/frontend/src/services/simple/simpleAuth.service.js`
- `/portal/backend/config/simple-auth.config.js`
- `/portal/frontend/src/components/dashboard/Dashboard.js`

## 確認方法

以下の手順で修正を確認できます：

1. ログアウト状態から新規にログイン
2. ダッシュボード画面に自動リダイレクトされる際にエラーが表示されないことを確認
3. ブラウザコンソールでエラーが記録されていないことを確認

## トラブルシューティング

修正後も問題が発生する場合：

1. ブラウザのローカルストレージをクリア
2. ブラウザキャッシュをクリア
3. アプリケーションを再起動
4. 問題が継続する場合はブラウザコンソールのログを確認