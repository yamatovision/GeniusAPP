# AppGenius認証システムと中央プロンプト管理 要件定義書

## 1. プロジェクト概要

### 1.1 目的
AppGeniusエコシステムに包括的な認証システムと中央プロンプト管理機能を提供することで、非技術者のAI開発をより安全かつ効率的に支援する。

### 1.2 背景
- 既存AppGeniusシステムに適切な認証機能が不足している
- プロンプトは各プロジェクトに散在しており、再利用や一貫性維持が困難
- セキュリティ要件の高まりによる認証・認可機能の必要性
- クラウドサービスとローカル開発環境の統合的な認証管理の要求

### 1.3 主要ステークホルダー
- 非技術者の開発者
- プロジェクト管理者
- セキュリティ管理者
- プロンプトエンジニア

## 2. システム構成

本プロジェクトは以下の2つの独立したシステムから構成されます：

1. **AppGenius VSCode拡張認証システム** - VSCode拡張内での認証機能
2. **中央プロンプト管理Webアプリケーション** - 独立したWebアプリケーション

これらはAPIを通じてデータ連携し、全体として統合されたエコシステムを形成します。

## 3. AppGenius VSCode拡張認証システム

### 3.1 機能要件

#### 3.1.1 ユーザー認証
- VSCode拡張起動時の認証チェック
- ログインフォームの提供（Webビュー）
- アクセストークンとリフレッシュトークンの管理
- 自動トークンリフレッシュ機能
- ログアウト機能

#### 3.1.2 認証状態管理
- 認証状態の永続化（セキュアストレージ）
- 認証状態に基づく機能制限
- セッションタイムアウト処理
- 認証エラー時のユーザーフィードバック

#### 3.1.3 ClaudeCode連携認証
- ClaudeCode CLIとの認証情報共有
- ClaudeCode APIアクセスの制御
- 認証失効時のAPI呼び出しブロック
- 共有認証データの同期

#### 3.1.4 オフライン動作
- 一時的なオフラインアクセスの許可
- 再接続時の認証状態同期
- オフライン作業の制限設定

### 3.2 非機能要件

#### 3.2.1 セキュリティ
- トークンの安全な保存（システムキーチェーン活用）
- 通信の暗号化（HTTPS）
- 最小権限の原則に基づくアクセス制御
- トークンのローテーションと失効管理

#### 3.2.2 ユーザビリティ
- シームレスな認証体験
- 明確な認証状態表示
- エラーメッセージの分かりやすさ
- 認証関連操作の最小化

#### 3.2.3 パフォーマンス
- 認証処理の高速化（500ms以内）
- バックグラウンドでのトークンリフレッシュ
- ネットワーク状態変化への対応

## 4. 中央プロンプト管理Webアプリケーション

### 4.1 機能要件

#### 4.1.1 ユーザー管理
- ユーザー登録・ログイン機能
- ユーザープロファイル管理
- パスワードリセット機能
- 管理者向けユーザー管理機能
- ユーザーアクセス権管理

#### 4.1.2 プロンプト管理
- プロンプトの作成・編集・削除
- プロンプトカテゴリ分類
- バージョン管理と履歴追跡
- タグ付けと検索機能
- プロンプトテスト機能

#### 4.1.3 プロジェクト管理
- プロジェクト作成と設定
- チームメンバー招待と権限設定
- プロジェクト内プロンプト管理
- 使用状況分析ダッシュボード

#### 4.1.4 API提供
- RESTful API提供
- API認証（JWT）
- SDK for VSCode連携
- レート制限と使用量監視

### 4.2 非機能要件

#### 4.2.1 セキュリティ
- ロールベースのアクセス制御
- データの暗号化（保存時・転送時）
- セキュアなパスワード管理
- セッション管理と不正アクセス検知
- アクセス監査ログ

#### 4.2.2 スケーラビリティ
- ユーザー数増加への対応
- データ量増加への対応
- マイクロサービスアーキテクチャ
- 水平スケーリング対応

#### 4.2.3 可用性
- 99.9%の稼働率
- バックアップと災害復旧計画
- 冗長構成

## 5. データ連携

### 5.1 認証連携要件
- 両システム間での認証状態の同期
- シングルサインオン（SSO）体験の提供
- 中央管理での権限変更の即時反映
- アクセス失効のリアルタイム伝播

### 5.2 プロンプトデータ連携
- VSCode拡張とWebアプリ間のプロンプト同期
- オフライン編集と競合解決
- 変更の双方向同期
- バージョン管理の統合

### 5.3 ユーザーデータ連携
- ユーザープロファイル情報の同期
- アクセス権限の一元管理
- 使用状況データの収集と分析
- プライバシー設定の尊重

## 6. ClaudeCode API統合管理

### 6.1 中央集中型API制御
- **マスターAPIキー管理**: 
  - 全ユーザーのClaudeCode要求は単一の管理されたAnthropicマスターAPIキーを通じて処理
  - 個々のユーザーに直接APIキーを配布しない方式
  - 管理者のみがマスターAPIキーにアクセス可能

- **プロキシ連携**:
  - すべてのClaudeCode APIリクエストは中央プロキシサーバーを経由
  - ユーザー認証状態と権限をリアルタイムで確認後にリクエスト転送
  - プロキシレベルでのログ記録と監視

### 6.2 ユーザー単位のアクセス管理
- **権限ベースのアクセス制御**:
  - ユーザーごとに細かなアクセス権限設定が可能
  - アクティブ/非アクティブユーザーステータスによる即時制御
  - リモートアクセス無効化機能（緊急時の使用停止）

- **組織階層管理**:
  - 部門/チーム/プロジェクトごとの利用者グループ管理
  - 組織構造に基づくアクセス権限の継承と上書き
  - 役割ベースのアクセス制御（RBAC）

### 6.3 詳細な使用量管理
- **ユーザー単位の使用量制限**:
  - ユーザーごとに日次/月次のトークン使用上限を設定
  - プラン（ベーシック/プロ/エンタープライズ）に基づく段階的制限
  - 上限到達時の自動ブロックまたは承認プロセス

- **使用量分析**:
  - ユーザー/チーム/プロジェクト別の使用状況リアルタイム表示
  - 傾向分析と予測レポート
  - コスト配分と内部請求管理
  - 異常使用パターンの検出とアラート

### 6.4 セキュリティ対策
- APIゲートウェイによるリクエスト検証
- 異常検知と自動ブロック
- リクエスト・レスポンスの監査ログ
- セキュリティインシデント対応プロトコル

## 7. 技術アーキテクチャ

### 7.1 VSCode拡張アーキテクチャ
- TypeScriptベース実装
- VSCode拡張API活用
- セキュアストレージ連携
- イベント駆動型設計

### 7.2 Webアプリケーションアーキテクチャ
- フロントエンド：React, TypeScript
- バックエンド：Node.js, Express
- データベース：MongoDB
- 認証：JWT, OAuth 2.0

### 7.3 API設計
- RESTful設計原則
- OpenAPI仕様
- バージョン管理
- エラーハンドリング標準化

## 8. セキュリティ要件

### 8.1 認証セキュリティ
- 多要素認証（MFA）オプション
- ブルートフォース攻撃対策
- セッションハイジャック防止
- 資格情報漏洩検知

### 8.2 データセキュリティ
- 保存データの暗号化
- 転送中データの暗号化（TLS 1.3）
- 機密データの最小化
- セキュアな削除プロセス

### 8.3 監査とコンプライアンス
- 詳細な監査ログ
- アクセス試行の記録
- 不審なアクティビティの検知と警告
- 定期的なセキュリティレビュー

## 9. 実装計画

### 9.1 フェーズ1：基本認証システム
- VSCode拡張の基本認証機能
- WebアプリのユーザーCRUD機能
- 基本的なAPI連携
- シンプルなプロンプト管理

### 9.2 フェーズ2：拡張機能
- プロンプトバージョン管理
- プロジェクト管理
- 高度な認証機能（MFAなど）
- オフライン同期

### 9.3 フェーズ3：ClaudeCode統合強化
- ClaudeCode API制御強化
- 使用分析ダッシュボード
- パフォーマンス最適化
- 高度なセキュリティ機能

## 10. 成功基準

- ユーザー認証のセキュリティインシデント0件
- VSCode拡張とWebアプリの認証連携100%成功率
- プロンプト管理効率30%向上
- ユーザー満足度85%以上

## 11. 用語集

- **認証（Authentication）**: ユーザーのアイデンティティを検証するプロセス
- **認可（Authorization）**: 認証されたユーザーに対して特定のリソースへのアクセス権を付与するプロセス
- **JWT**: JSON Web Token、認証情報を安全に転送するための標準規格
- **アクセストークン**: 短期間有効な認証トークン
- **リフレッシュトークン**: アクセストークンの再発行に使用される長期的なトークン
- **SSO**: Single Sign-On、複数のシステムで一度の認証で利用可能にする仕組み

## 12. 承認

- 日付：2025年3月12日
- バージョン：1.0
- 承認者：AppGenius プロジェクトマネージャー