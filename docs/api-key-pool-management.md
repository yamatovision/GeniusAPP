# APIキープール管理システム仕様書

## 概要

APIキープール管理システムは、企業向けサービスとしてAppGeniusで提供されるAnthropicのAPIキー管理を効率化するためのシステムです。顧客企業ごとに事前発行したAPIキーをプールとして管理し、企業管理者がユーザーに必要に応じてAPIキーを割り当てることができます。これにより、AppGeniusからの介入なしに企業が自律的にAPIキー管理を行うことが可能になります。

## 目的

1. 企業向けサービスとしての従量課金制を実現するための基盤構築
2. 企業管理者によるAPIキー自己管理の実現
3. アプリ内での使用量集計と可視化の提供
4. セキュアで効率的なAPIキー割り当てプロセスの確立

## システム構成

### データモデル/Users/tatsuya/Desktop/システム開発/AppGenius2/AppGenius/docs/prompts/project_analyzer.md

#### 1. 組織（Organization）モデル拡張

```javascript
// 組織モデルにAPIキープールを追加
apiKeyPool: [{
  keyName: String,         // "Company_A_Secret_001" などの識別名
  keyId: String,           // Anthropicから取得するAPIキーID
  actualKey: String,       // 暗号化されたAPIキー
  status: {
    type: String,
    enum: ['available', 'assigned', 'revoked'],
    default: 'available'
  },
  assignedTo: {            // 割当先ユーザーID
    type: Schema.Types.ObjectId,
    ref: 'User'
  },
  assignedAt: Date,        // 割当日時
  department: String,      // 部署情報（オプション）
  metadata: Map            // その他メタデータ
}]
```

#### 2. ユーザー（User）モデル拡張

```javascript
// ユーザーモデルにAPIキー参照を追加
apiKeyInfo: {
  poolKeyId: String,      // 組織のapiKeyPoolからの参照ID
  assignedAt: Date        // 割当日時
}
```

#### 3. 使用量データモデル

```javascript
// APIキーごとの使用量データ
const ApiKeyUsageSchema = new Schema({
  organization: {
    type: Schema.Types.ObjectId,
    ref: 'Organization',
    required: true
  },
  apiKeyId: {              // AnthropicのAPIキーID
    type: String,
    required: true,
    index: true
  },
  date: {                  // 使用日（YYYY-MM-DD）
    type: String,
    required: true,
    index: true
  },
  model: String,           // モデル名
  inputTokens: Number,     // 入力トークン数
  outputTokens: Number,    // 出力トークン数
  totalTokens: Number,     // 合計トークン数
  importedAt: Date         // インポート日時
});
```

### コンポーネント

1. **APIキープール管理**
   - APIキーの登録・管理
   - ステータス更新（利用可能・割当済み・無効）
   - 企業管理者向け一覧・詳細表示

2. **ユーザー管理連携**
   - ユーザーへのAPIキー割り当て
   - 割り当て解除・再割り当て
   - ユーザー情報と連携した表示

3. **使用量データ管理**
   - CSV形式の使用量データインポート
   - APIキーとユーザーの紐付けに基づく集計
   - 組織・部署・ユーザー別の集計

4. **レポート機能**
   - 使用量グラフ表示
   - 期間別（日次・月次）レポート
   - エクスポート機能

## 機能仕様

### 1. APIキープール管理

#### APIキーの一括登録
- 管理者がCSVで複数のAPIキーを一括登録
- 形式: `キー名,キーID,実際のキー値`
- 登録時に自動的に暗号化

#### APIキー一覧表示
- 組織ごとのAPIキー一覧
- フィルタリング（状態別、割り当て状況別）
- 検索機能（キー名、ユーザー名）

#### APIキー詳細表示
- キー情報（名前、ID、状態）
- 割り当て状況
- 使用量サマリー

### 2. ユーザー管理連携

#### APIキー割り当て
- 企業管理者がユーザーにAPIキーを割り当て
- 未割り当てのキーから自動選択または手動選択
- 割り当て時にメール通知オプション

#### 割り当て解除
- 不要になったキーの割り当て解除
- 解除理由の記録
- 解除後のステータス選択（再利用可/無効化）

#### ユーザー別APIキー表示
- ユーザーごとに割り当てられたAPIキー表示
- 使用状況サマリー
- キー情報の詳細表示

### 3. 使用量データ管理

#### CSVインポート
- Anthropicからダウンロードした使用量データのインポート
- 日付・APIキー・モデル・トークン数の取り込み
- 重複チェックと累積集計

#### 使用量集計
- APIキーごとの使用量集計
- ユーザー別・部署別・組織別の集計
- 日次・月次・期間指定集計

#### 使用状況モニタリング
- リアルタイム（最新インポートデータ基準）の使用状況表示
- 予算に対する使用率表示
- アラート設定（80%、90%、100%など）

### 4. レポート機能

#### グラフ表示
- 日次・月次使用量グラフ
- ユーザー別・部署別比較グラフ
- モデル別使用量分布

#### エクスポート
- PDF・CSV形式でのレポートエクスポート
- カスタムレポート設定
- 定期レポート自動生成オプション

## ユーザーフロー

### 1. 初期セットアップフロー

1. AppGeniusとの契約締結
2. 企業用に必要数のAPIキーをAnthropicコンソールで作成
3. AppGenius管理者がシステムにAPIキーを一括登録
4. 企業管理者アカウントの設定と権限付与
5. 管理マニュアルの提供

### 2. 企業管理者フロー

1. 管理ダッシュボードでAPIキープールの確認
2. 社員ユーザー情報の登録（名前、メール、部署など）
3. ユーザーごとにAPIキーを割り当て
4. 使用状況の定期的なモニタリング
5. 使用量レポートの確認とエクスポート

### 3. 一般ユーザーフロー

1. 招待メールから登録またはログイン
2. APIキー情報の確認
3. APIキーをClaudeCodeなどのツールで設定
4. 利用開始と使用状況の確認

### 4. 使用量データ管理フロー

1. 管理者がAnthropicコンソールからCSVデータをダウンロード
2. システムにCSVをインポート
3. データの自動処理と集計
4. 使用量ダッシュボードの自動更新
5. レポート生成と配布

## API設計

### APIキープール管理API

#### 1. APIキー一括登録
```
POST /api/organizations/:organizationId/api-keys/batch
```

#### 2. APIキー一覧取得
```
GET /api/organizations/:organizationId/api-keys
```

#### 3. APIキー詳細取得
```
GET /api/organizations/:organizationId/api-keys/:keyId
```

#### 4. APIキー割り当て
```
POST /api/organizations/:organizationId/api-keys/:keyId/assign
```

#### 5. APIキー割り当て解除
```
POST /api/organizations/:organizationId/api-keys/:keyId/unassign
```

### 使用量データAPI

#### 1. 使用量データインポート
```
POST /api/usage/import
```

#### 2. 組織別使用量取得
```
GET /api/organizations/:organizationId/usage
```

#### 3. ユーザー別使用量取得
```
GET /api/organizations/:organizationId/users/:userId/usage
```

#### 4. 使用量レポート生成
```
GET /api/organizations/:organizationId/usage/report
```

## セキュリティ考慮事項

1. **APIキーの暗号化**
   - APIキーは保存時に暗号化
   - 使用時のみ一時的に復号化
   - 暗号鍵の安全な管理

2. **アクセス制御**
   - 役割ベースのアクセス制御
   - 企業管理者は自社のAPIキーのみ管理可能
   - 一般ユーザーは自分のAPIキーのみ閲覧可能

3. **監査ログ**
   - APIキー割り当て・解除の履歴保存
   - 使用量データインポートの履歴
   - 管理操作の監査ログ

4. **データ分離**
   - 組織ごとのデータ完全分離
   - クロスアカウント参照の防止
   - セキュリティ監査機能

## 実装計画

### フェーズ1: 基本機能実装（3日）
- 組織モデルのAPIキープール拡張
- ユーザーモデルの拡張
- 基本的なAPIキー管理API実装
- 管理UIの基本実装

### フェーズ2: 使用量管理（2日）
- 使用量データモデル実装
- CSVインポート機能
- 使用量集計機能
- 基本的なグラフ表示

### フェーズ3: レポート機能（2日）
- 詳細レポート機能
- エクスポート機能
- カスタマイズオプション
- メール通知機能

### フェーズ4: テストと仕上げ（2日）
- 機能テスト
- UIの改善と調整
- ドキュメント作成
- デプロイ準備

## UIワイヤーフレーム

### 管理ダッシュボード
- 組織概要（メンバー数、APIキー数、使用状況）
- クイックアクション（ユーザー追加、APIキー管理、レポート生成）
- 使用量サマリーグラフ

### APIキープール管理画面
- APIキー一覧（表形式）
  - キー名
  - ステータス
  - 割り当て先
  - 使用量サマリー
  - アクション（割り当て、解除、無効化）
- 検索・フィルタリングオプション
- インポート/エクスポートボタン

### ユーザー管理画面
- ユーザー一覧（表形式）
  - 名前
  - メール
  - 部署
  - APIキー情報
  - 使用状況
  - アクション（APIキー割り当て、解除）
- 検索・フィルタリングオプション
- 一括操作オプション

### 使用量レポート画面
- 期間選択オプション
- グラフ表示領域（棒グラフ、折れ線グラフ、円グラフ）
- 詳細データ表示（表形式）
- エクスポートオプション

## 実装上の注意点

1. **スケーラビリティ**
   - 大量のAPIキーとユーザーを効率的に管理できる設計
   - データベースインデックスの最適化
   - クエリパフォーマンスの考慮

2. **ユーザビリティ**
   - 直感的なUI設計
   - 一括操作機能の提供
   - フィードバックメカニズムの充実

3. **データ整合性**
   - トランザクション処理の適用
   - 同時操作の衝突解決
   - データ検証と整合性チェック

4. **メンテナンス性**
   - モジュール化された設計
   - 設定の外部化
   - 適切なログ記録

## まとめ

APIキープール管理システムは、AppGeniusの企業向けサービスとしての価値を高める重要な機能です。このシステムにより、企業は自律的にAnthropicのAPIキーを管理し、使用量を監視することができます。また、AppGeniusは正確な使用量データに基づいて従量課金制のサービスを提供することが可能になり、企業と個人ユーザーの両方にとって価値のある環境を構築できます。

この仕様をもとに、段階的に実装を進め、ユーザーからのフィードバックを取り入れながら継続的に改善していくことが推奨されます。